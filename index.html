<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>volt ¬∑ portfolio risk analyzer</title>
    <link href="https://fonts.googleapis.com/css2?family=Space+Grotesk:wght@400;500;600;700&display=swap"
        rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    <script src="./config.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Space Grotesk', sans-serif;
        }

        body {
            background-color: #0c0f15;
            color: #eaeef2;
            line-height: 1.5;
            padding: 4.5rem 2rem 2rem 2rem;
        }

        .glass {
            background: rgba(20, 28, 36, 0.7);
            backdrop-filter: blur(12px);
            -webkit-backdrop-filter: blur(12px);
            border: 1px solid rgba(0, 255, 200, 0.15);
            border-radius: 28px;
            box-shadow: 0 25px 40px -15px rgba(0, 0, 0, 0.6);
        }

        .app {
            max-width: 1600px;
            margin: 0 auto;
        }

        .logo {
            display: flex;
            align-items: center;
            gap: 12px;
            margin-bottom: 2rem;
        }

        .logo-icon {
            background: linear-gradient(145deg, #00ffc6, #9f7afe);
            width: 48px;
            height: 48px;
            border-radius: 18px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 700;
            font-size: 1.8rem;
            color: #0c0f15;
            box-shadow: 0 0 20px #00ffc680;
        }

        .logo h1 {
            font-weight: 600;
            font-size: 2rem;
            letter-spacing: -0.02em;
            background: linear-gradient(120deg, #ffffff, #b0f0ff);
            background-clip: text;
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        .logo span {
            background: #ff4d6d;
            color: #0c0f15;
            font-size: 0.8rem;
            font-weight: 600;
            padding: 0.2rem 0.8rem;
            border-radius: 40px;
            margin-left: 12px;
            text-transform: uppercase;
        }

        .input-panel {
            padding: 1.8rem 2rem;
            margin-bottom: 2rem;
            display: flex;
            flex-wrap: wrap;
            align-items: flex-end;
            gap: 2rem;
        }

        .ticker-list {
            flex: 3;
            min-width: 500px;
        }

        .ticker-row {
            display: flex;
            gap: 12px;
            margin-bottom: 12px;
            align-items: center;
        }

        .ticker-row input {
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid #2e3a44;
            border-radius: 40px;
            padding: 12px 18px;
            color: white;
            font-size: 1rem;
            transition: all 0.2s;
        }

        .ticker-row input:focus {
            border-color: #00ffc6;
            outline: none;
            box-shadow: 0 0 0 3px rgba(0, 255, 198, 0.2);
        }

        .ticker-symbol {
            width: 130px;
        }

        .ticker-weight {
            width: 100px;
        }

        .remove-btn {
            background: none;
            border: none;
            color: #ff8a9f;
            font-size: 1.4rem;
            cursor: pointer;
            padding: 0 8px;
        }

        .add-btn {
            background: rgba(0, 255, 198, 0.1);
            border: 1.5px dashed #00ffc6;
            border-radius: 40px;
            padding: 10px 24px;
            color: #00ffc6;
            font-weight: 600;
            cursor: pointer;
            transition: 0.2s;
            margin-top: 8px;
        }

        .add-btn:hover {
            background: #00ffc6;
            color: #0c0f15;
        }

        .action-buttons {
            flex: 1;
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        .primary-btn,
        .secondary-btn {
            padding: 14px 24px;
            border-radius: 50px;
            font-weight: 600;
            border: none;
            cursor: pointer;
            font-size: 1rem;
            transition: 0.2s;
        }

        .primary-btn {
            background: linear-gradient(145deg, #00ffc6, #9f7afe);
            color: #0c0f15;
            box-shadow: 0 6px 14px rgba(0, 255, 200, 0.3);
        }

        .primary-btn:hover {
            transform: scale(1.02);
            box-shadow: 0 10px 20px #00ffc670;
        }

        .secondary-btn {
            background: transparent;
            border: 2px solid #ff4d6d;
            color: #ff4d6d;
        }

        .secondary-btn:hover {
            background: #ff4d6d20;
        }

        .tabs {
            display: flex;
            gap: 6px;
            margin: 2rem 0 1rem;
            flex-wrap: wrap;
        }

        .tab {
            padding: 12px 28px;
            background: rgba(30, 40, 50, 0.7);
            border-radius: 60px;
            font-weight: 500;
            color: #b0c4d9;
            cursor: pointer;
            border: 1px solid transparent;
            transition: 0.2s;
        }

        .tab.active {
            background: #1f2e3a;
            border-color: #00ffc6;
            color: white;
            box-shadow: 0 0 12px #00ffc640;
        }

        .tab:hover {
            background: #25333f;
        }

        .content-card {
            padding: 2rem;
            margin-bottom: 2.5rem;
        }

        .metrics-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1.5rem;
        }

        .metric-item {
            background: rgba(0, 0, 0, 0.3);
            border-radius: 24px;
            padding: 1.4rem;
            border-left: 4px solid #00ffc6;
        }

        .metric-label {
            font-size: 0.85rem;
            text-transform: uppercase;
            letter-spacing: 0.06em;
            color: #90a4b9;
        }

        .metric-value {
            font-size: 2rem;
            font-weight: 600;
            color: #fff;
        }

        .metric-unit {
            font-size: 0.9rem;
            color: #7f8fa3;
        }

        .table-wrapper {
            overflow-x: auto;
        }

        table {
            width: 100%;
            border-collapse: collapse;
        }

        th {
            text-align: left;
            padding: 1rem 0.5rem;
            color: #00ffc6;
            font-weight: 500;
            border-bottom: 1px solid #2e444e;
        }

        td {
            padding: 0.8rem 0.5rem;
            border-bottom: 1px solid #1e2f38;
        }

        .badge {
            background: #ff4d6d;
            color: #0c0f15;
            border-radius: 30px;
            padding: 0.2rem 0.9rem;
            font-weight: 600;
            font-size: 0.8rem;
            display: inline-block;
        }

        .chart-container {
            height: 300px;
            margin-top: 2rem;
        }

        .flex-row {
            display: flex;
            gap: 2rem;
            flex-wrap: wrap;
        }

        .shock-row {
            display: flex;
            gap: 12px;
            align-items: center;
            margin: 1rem 0;
        }

        .shock-input {
            background: #1b262d;
            border: 1px solid #314956;
            border-radius: 30px;
            padding: 10px 16px;
            color: white;
            width: 120px;
        }

        .error-msg {
            color: #ff8a9f;
            background: #ff4d6d20;
            border-radius: 30px;
            padding: 12px 20px;
        }

        .positive {
            color: #00ffc6;
            font-weight: 600;
        }

        .negative {
            color: #ff4d6d;
            font-weight: 600;
        }

        .scenario-desc {
            color: #b0c4d9;
            font-size: 0.9rem;
            margin: 5px 0 15px;
        }

        /* Marquee styles */
        .marquee-container {
            width: 100%;
            overflow: hidden;
            background: rgba(10, 13, 18, 0.9);
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            border-bottom: 1px solid rgba(0, 255, 200, 0.1);
            padding: 10px 0;
            white-space: nowrap;
            position: fixed;
            top: 0;
            left: 0;
            z-index: 1000;
        }

        .marquee-content {
            display: inline-flex;
            animation: marquee 30s linear infinite;
        }

        .marquee-content:hover {
            animation-play-state: paused;
        }

        .stock-item {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            margin-right: 50px;
            font-size: 0.95rem;
        }

        .stock-ticker {
            font-weight: 700;
            color: #b0c4d9;
        }

        .stock-price {
            font-weight: 500;
            color: #fff;
        }

        .stock-change {
            font-weight: 600;
            font-size: 0.85rem;
            padding: 2px 6px;
            border-radius: 4px;
        }

        .stock-change.positive {
            color: #141c24;
            background-color: #00ffc6;
        }

        .stock-change.negative {
            color: #141c24;
            background-color: #ff4d6d;
        }

        @keyframes marquee {
            0% { transform: translateX(100vw); }
            100% { transform: translateX(-100%); }
        }
    </style>
</head>

<body>
    <div class="marquee-container" id="stockMarqueeContainer">
        <div class="marquee-content" id="stockMarquee">
            <span style="color: #90a4b9; font-size: 0.9rem; padding-left: 2rem;">loading live markets...</span>
        </div>
    </div>
    <div class="app">
        <div class="logo">
            <div class="logo-icon">üìà</div>
            <h1>volt. <span>risk analyzer</span></h1>
        </div>

        <!-- API Configuration Debug (hidden on production) -->
        <div id="debugInfo" style="display: none; background: #1f2e3a; padding: 12px 20px; border-radius: 12px; margin-bottom: 1.5rem; font-size: 0.85rem; border: 1px solid #00ffc6;">
            <div style="color: #00ffc6; font-weight: 600;">üîß API Configuration</div>
            <div style="color: #90a4b9; margin-top: 8px;">Backend URL: <span id="debugBackendUrl">Loading...</span></div>
            <div style="color: #90a4b9;">Status: <span id="debugStatus" style="color: #ff4d6d;">Checking...</span></div>
        </div>

        <!-- portfolio input panel -->
        <div class="glass input-panel">
            <div class="ticker-list" id="tickerList">
                <div class="ticker-row" id="rowTemplate" style="display: none;">
                    <input class="ticker-symbol" placeholder="AAPL" value="AAPL">
                    <input class="ticker-weight" placeholder="weight" value="0.5" step="0.01" min="0" max="1">
                    <button class="remove-btn" onclick="removeRow(this)">‚úï</button>
                </div>
            </div>
            <div class="action-buttons">
                <button class="primary-btn" onclick="addTickerRow()">+ add asset</button>
                <button class="secondary-btn" onclick="validateTickers()">‚úì validate</button>
                <button class="primary-btn" onclick="loadFullAnalysis()"
                    style="background: linear-gradient(145deg,#ff4d6d,#ff8a9f);">üî• analyze</button>
            </div>
        </div>

        <!-- tabs navigation -->
        <div class="tabs">
            <div class="tab active" data-tab="overview" onclick="switchTab('overview')">üìä overview</div>
            <div class="tab" data-tab="correlation" onclick="switchTab('correlation')">üîó correlation</div>
            <div class="tab" data-tab="montecarlo" onclick="switchTab('montecarlo')">üåÄ monte carlo</div>
            <div class="tab" data-tab="scenario" onclick="switchTab('scenario')">‚ö° scenario</div>
            <div class="tab" data-tab="stress" onclick="switchTab('stress')">üß™ stress + future</div>
        </div>

        <!-- global message -->
        <div id="globalMessage" class="error-msg" style="display: none;"></div>

        <!-- OVERVIEW TAB -->
        <div id="overview" class="tab-content">
            <div class="glass content-card">
                <h2 style="margin-bottom: 1.5rem; color:#00ffc6;">üìã portfolio summary</h2>
                <div class="metrics-grid" id="summaryMetrics"></div>
            </div>
            <div class="glass content-card">
                <h2 style="margin-bottom: 1.5rem;">üìâ var & risk metrics</h2>
                <div class="metrics-grid" id="varMetrics"></div>
            </div>
            <div class="glass content-card">
                <h2 style="margin-bottom: 1.5rem;">üèÜ performance & benchmark</h2>
                <div class="flex-row">
                    <div style="flex:2" id="perfRatios"></div>
                    <div style="flex:1" id="benchmarkInfo"></div>
                </div>
            </div>
            <div class="glass content-card">
                <h2>üìà cumulative performance (history)</h2>
                <div class="chart-container">
                    <canvas id="historyChart"></canvas>
                </div>
            </div>
            <div class="glass content-card">
                <h2>üß© individual asset risk</h2>
                <div class="table-wrapper" id="individualRiskTable"></div>
            </div>
        </div>

        <!-- CORRELATION TAB -->
        <div id="correlation" class="tab-content" style="display: none;">
            <div class="glass content-card">
                <h2 style="margin-bottom: 1.5rem;">üîó correlation matrix</h2>
                <div class="table-wrapper" id="correlationMatrix"></div>
            </div>
            <div class="glass content-card">
                <h2 style="margin-bottom: 1.5rem;">üìä covariance matrix</h2>
                <div class="table-wrapper" id="covarianceMatrix"></div>
            </div>
        </div>

        <!-- MONTE CARLO TAB -->
        <div id="montecarlo" class="tab-content" style="display: none;">
            <div class="glass content-card">
                <h2>üåÄ monte carlo simulation</h2>
                <div style="display: flex; gap: 20px; align-items: center; margin: 20px 0; flex-wrap:wrap;">
                    <label>simulations: <input type="number" id="mcSims" value="5000" min="1000" max="20000" step="1000"
                            style="background:#1f2e3a; border: none; color:white; padding:8px; border-radius:20px;"></label>
                    <label>days: <input type="number" id="mcDays" value="252" min="60" max="504"
                            style="background:#1f2e3a; border: none; color:white; padding:8px; border-radius:20px;"></label>
                    <label>investment ‚Çπ: <input type="number" id="mcInvest" value="100000"
                            style="background:#1f2e3a; border: none; color:white; padding:8px; border-radius:20px;"></label>
                    <button class="primary-btn" onclick="runMonteCarlo()">run simulation</button>
                </div>
                <div class="chart-container">
                    <canvas id="mcChart"></canvas>
                </div>
                <div class="metrics-grid" id="mcStats" style="margin-top: 20px;"></div>
            </div>
        </div>

        <!-- SCENARIO TAB (shock analysis) -->
        <div id="scenario" class="tab-content" style="display: none;">
            <div class="glass content-card">
                <h2>‚ö° what‚Äëif shocks</h2>
                <div id="shockInputs"></div>
                <button class="primary-btn" onclick="runShockAnalysis()" style="margin: 20px 0;">apply shocks</button>
                <div class="flex-row" id="shockResults"></div>
            </div>
        </div>

        <!-- STRESS TEST TAB (with future predictions) -->
        <div id="stress" class="tab-content" style="display: none;">
            <div class="glass content-card">
                <h2>üß™ historical & future stress tests</h2>
                <select id="scenarioSelect"
                    style="background:#1f2e3a; color:white; padding:12px 20px; border-radius:40px; margin:20px 0; border:1px solid #00ffc6; min-width:300px;"></select>
                <button class="primary-btn" onclick="runStressTest()">run stress test</button>
                <div id="stressResults" style="margin-top: 30px;"></div>
            </div>
        </div>
    </div>
    <script>
    /* ================= CONFIG ================= */
    // Backend URL is loaded from config.js
    const BACKEND_URL = window.API_CONFIG?.BACKEND_URL || window.location.origin;
    
    if (!BACKEND_URL) {
        console.error('ERROR: Backend URL is not configured. Please set VITE_BACKEND_URL environment variable.');
    }

    /* ================= GLOBAL STATE ================= */
    let holdings = [
    { ticker: "AAPL", weight: 0.4 },
    { ticker: "MSFT", weight: 0.3 },
    { ticker: "GOOGL", weight: 0.3 }
    ];

    let historyChartInstance = null;
    let mcChartInstance = null;

    /* ================= INIT ================= */
    window.onload = function () {
        renderTickerRows();
        initShockInputs();
        initScenariosDropdown();
        updateLiveMarquee();
        checkApiConnection();
        setInterval(updateLiveMarquee, 30000);  // Update every 30 seconds
        switchTab('overview');
    };

    function checkApiConnection() {
        const debugUrl = document.getElementById('debugBackendUrl');
        const debugStatus = document.getElementById('debugStatus');
        const debugInfo = document.getElementById('debugInfo');
        
        // Show debug info in development
        if (window.location.hostname === 'localhost' || window.location.hostname === '127.0.0.1') {
            debugInfo.style.display = 'block';
        }
        
        debugUrl.textContent = BACKEND_URL || 'Not configured';
        
        if (!BACKEND_URL) {
            debugStatus.textContent = '‚ùå No backend URL configured';
            debugStatus.style.color = '#ff4d6d';
            showMessage('ERROR: Backend API URL not configured. Please set VITE_BACKEND_URL environment variable.');
            return;
        }
        
        // Test health check
        fetchGet('/api/health')
            .then(data => {
                debugStatus.textContent = '‚úÖ Connected';
                debugStatus.style.color = '#00ffc6';
                console.log('‚úì Backend connection successful!', data);
            })
            .catch(err => {
                debugStatus.innerHTML = `‚ùå Failed: ${err.message.substring(0, 50)}...`;
                debugStatus.style.color = '#ff4d6d';
                console.error('‚úó Backend connection failed:', err);
            });
    }

    function initShockInputs() {
        const h = getHoldingsFromUI();
        let html = '';
        h.forEach(holding => {
            html += `
                <div class="shock-row">
                    <span style="min-width:80px; font-weight:600;">${holding.ticker}</span>
                    <input type="hidden" class="shock-ticker" value="${holding.ticker}">
                    <label>shock %: <input type="number" class="shock-pct" value="-10" min="-100" max="100" style="background:#1f2e3a; border:none; color:white; padding:8px; border-radius:20px; width:100px;"></label>
                </div>
            `;
        });
        document.getElementById("shockInputs").innerHTML = html;
    }

    function initScenariosDropdown() {
        const scenarios = [
            { key: "2008_crisis", name: "2008 Financial Crisis" },
            { key: "1987_crash", name: "1987 Black Monday" },
            { key: "covid_2020", name: "COVID-19 (2020)" },
            { key: "tech_correction", name: "Tech Correction" }
        ];

        let html = `<option value="">-- Select Scenario --</option>`;
        scenarios.forEach(s => {
            html += `<option value="${s.key}">${s.name}</option>`;
        });
        document.getElementById("scenarioSelect").innerHTML = html;
    }

    async function updateLiveMarquee() {
        try {
            const tickers = holdings.map(h => h.ticker).join(",") || "AAPL,MSFT,GOOGL,NVDA,TSLA";
            const data = await fetchGet(`/api/portfolio/live-prices?tickers=${tickers}`);
            const prices = data.prices || [];

            let marqueeHtml = '';
            prices.forEach(p => {
                const changeClass = p.change_pct >= 0 ? 'positive' : 'negative';
                const changeSymbol = p.change_pct >= 0 ? '+' : '';
                marqueeHtml += `
                    <div class="stock-item">
                        <span class="stock-ticker">${p.ticker}</span>
                        <span class="stock-price">‚Çπ${p.price}</span>
                        <span class="stock-change ${changeClass}">${changeSymbol}${p.change_pct}%</span>
                    </div>
                `;
            });

            // Double it for seamless loop
            marqueeHtml += marqueeHtml;
            document.getElementById("stockMarquee").innerHTML = marqueeHtml;
        } catch (e) {
            console.error("Marquee update failed:", e);
        }
    }

    /* ================= API HELPERS ================= */
    async function fetchGet(endpoint) {
        if (!BACKEND_URL) {
            throw new Error('Backend API URL not configured. Check your environment variables.');
        }
        
        const url = `${BACKEND_URL}${endpoint}`;
        console.log('GET:', url);
        
        try {
            const res = await fetch(url, {
                method: 'GET',
                headers: { 'Content-Type': 'application/json' },
                credentials: 'include'  // For CORS with credentials
            });
            
            const text = await res.text();
            let data;
            
            try {
                data = JSON.parse(text);
            } catch (err) {
                console.error("Response was not JSON:", text, "Status:", res.status);
                throw new Error(`Server error (${res.status}): ${text.substring(0, 200)}`);
            }
            
            if (!res.ok) {
                throw new Error(data.error || `API error: ${res.status}`);
            }
            
            return data;
        } catch (error) {
            console.error('API Error:', error);
            if (error.message.includes('Failed to fetch')) {
                throw new Error(`Cannot reach backend API. Make sure:\n1. Backend server is running\n2. Backend URL is correct: ${BACKEND_URL}\n3. CORS is enabled in backend\n\nOriginal: ${error.message}`);
            }
            throw error;
        }
    }

    async function callApi(endpoint, body) {
        if (!BACKEND_URL) {
            throw new Error('Backend API URL not configured. Check your environment variables.');
        }
        
        const url = `${BACKEND_URL}${endpoint}`;
        console.log('POST:', url, 'Body:', body);
        
        try {
            const res = await fetch(url, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(body),
                credentials: 'include'  // For CORS with credentials
            });
            
            const text = await res.text();
            let data;
            
            try {
                data = JSON.parse(text);
            } catch (err) {
                console.error("Response was not JSON:", text, "Status:", res.status);
                throw new Error(`Server error (${res.status}): ${text.substring(0, 200)}`);
            }
            
            if (!res.ok) {
                throw new Error(data.error || `API error: ${res.status}`);
            }
            
            return data;
        } catch (error) {
            console.error('API Error:', error);
            if (error.message.includes('Failed to fetch')) {
                throw new Error(`Cannot reach backend API. Make sure:\n1. Backend server is running at: ${BACKEND_URL}\n2. CORS is enabled in backend\n3. Network allows cross-origin requests`);
            }
            throw error;
        }
    }

    function showMessage(msg, isError = true) {
    const el = document.getElementById("globalMessage");
    el.style.display = "block";
    el.innerText = msg;
    el.style.background = isError ? "#ff4d6d20" : "#00ffc620";
    setTimeout(() => (el.style.display = "none"), 4000);
    }

    /* ================= TICKER UI ================= */
    function renderTickerRows() {
    const container = document.getElementById("tickerList");
    container.querySelectorAll('.ticker-row:not([id="rowTemplate"])').forEach(el => el.remove());

    holdings.forEach(h => {
        const row = createRowFromTemplate(h.ticker, h.weight);
        container.appendChild(row);
    });
    }

    function createRowFromTemplate(ticker, weight) {
    const template = document.getElementById("rowTemplate");
    const row = template.cloneNode(true);
    row.style.display = "flex";
    row.removeAttribute("id");
    row.querySelector(".ticker-symbol").value = ticker;
    row.querySelector(".ticker-weight").value = weight;
    return row;
    }

    function addTickerRow() {
    const container = document.getElementById("tickerList");
    container.appendChild(createRowFromTemplate("", ""));
    }

    function removeRow(btn) {
    const rows = document.querySelectorAll('.ticker-row:not([id="rowTemplate"])');
    if (rows.length > 1) btn.closest(".ticker-row").remove();
    else alert("Keep at least one asset");
    }

    function getHoldingsFromUI() {
    const rows = document.querySelectorAll('.ticker-row:not([id="rowTemplate"])');
    const h = [];
    rows.forEach(row => {
        const ticker = row.querySelector(".ticker-symbol").value.trim().toUpperCase();
        const weight = parseFloat(row.querySelector(".ticker-weight").value);
        if (ticker && !isNaN(weight)) h.push({ ticker, weight });
    });

    const total = h.reduce((a, b) => a + b.weight, 0);
    if (total > 0) h.forEach(x => x.weight /= total);
    return h;
    }

    /* ================= VALIDATE ================= */
    async function validateTickers() {
    const h = getHoldingsFromUI();
    try {
        const data = await callApi("/api/portfolio/validate", { tickers: h.map(x => x.ticker) });
        if (data.invalid.length === 0) showMessage("‚úÖ All tickers valid", false);
        else showMessage("‚ùå Invalid: " + data.invalid.join(", "));
    } catch (e) {
        showMessage(e.message);
    }
    }

    /* ================= MAIN ANALYSIS ================= */
    async function loadFullAnalysis() {
    const h = getHoldingsFromUI();
    if (!h.length) return showMessage("Enter at least one asset");

    holdings = h;

    try {
        const metrics = await callApi("/api/risk/metrics", { holdings: h });
        renderOverview(metrics);

        const corr = await callApi("/api/risk/correlation", { holdings: h });
        renderCorrelation(corr);

        const indiv = await callApi("/api/risk/individual", { holdings: h });
        renderIndividualRisk(indiv.assets);

        // Reinitialize shock and scenario inputs
        initShockInputs();
        initScenariosDropdown();

        switchTab("overview");
    } catch (e) {
        showMessage(e.message);
    }
    }

    /* ================= RENDER FUNCTIONS ================= */
    function renderOverview(data) {
    const s = data.portfolio_summary || {};
    const r = data.return_metrics || {};
    const risk = data.risk_metrics || {};
    const varM = data.var_metrics || {};
    const perf = data.performance_ratios || {};
    const bench = data.benchmark_metrics || {};

    document.getElementById("summaryMetrics").innerHTML = `
        <div class="metric-item"><div class="metric-label">Tickers</div><div class="metric-value">${(s.tickers || []).join(", ")}</div></div>
        <div class="metric-item"><div class="metric-label">Investment</div><div class="metric-value">‚Çπ${(s.investment_amount || 0).toLocaleString()}</div></div>
        <div class="metric-item"><div class="metric-label">Ann. Return</div><div class="metric-value">${r.annualized_return_pct || 0}%</div></div>
        <div class="metric-item"><div class="metric-label">Ann. Volatility</div><div class="metric-value">${risk.annualized_volatility_pct || 0}%</div></div>
        <div class="metric-item"><div class="metric-label">Max Drawdown</div><div class="metric-value">${risk.max_drawdown_pct || 0}%</div></div>
    `;

    document.getElementById("varMetrics").innerHTML = `
        <div class="metric-item"><div class="metric-label">Historical VaR (95%)</div><div class="metric-value">${varM.historical_var_1d_pct || 0}%</div><div class="metric-unit">‚Çπ${varM.historical_var_1d_dollar || 0}</div></div>
        <div class="metric-item"><div class="metric-label">Parametric VaR</div><div class="metric-value">${varM.parametric_var_1d_pct || 0}%</div></div>
        <div class="metric-item"><div class="metric-label">Historical CVaR</div><div class="metric-value">${varM.historical_cvar_1d_pct || 0}%</div></div>
        <div class="metric-item"><div class="metric-label">Parametric CVaR</div><div class="metric-value">${varM.parametric_cvar_1d_pct || 0}%</div></div>
    `;

    document.getElementById("perfRatios").innerHTML = `
        <div><span class="badge">Sharpe</span> ${perf.sharpe_ratio || 0}</div>
        <div><span class="badge">Sortino</span> ${perf.sortino_ratio || 0}</div>
    `;
    document.getElementById("benchmarkInfo").innerHTML = `
        <div><span class="badge">beta</span> ${bench.beta || 0}</div>
        <div><span class="badge">alpha</span> ${bench.alpha_pct || 0}%</div>
    `;

    // History chart
    const hist = data.historical_performance || {};
    if (historyChartInstance) historyChartInstance.destroy();
    const ctx = document.getElementById("historyChart").getContext("2d");
    historyChartInstance = new Chart(ctx, {
        type: "line",
        data: {
            labels: (hist.dates || []).filter((_, i) => i % 20 === 0),
            datasets: [
                { label: "portfolio", data: (hist.portfolio || []).filter((_, i) => i % 20 === 0), borderColor: "#00ffc6", tension: 0.1, pointRadius: 0 },
                { label: "benchmark", data: (hist.benchmark || []).filter((_, i) => i % 20 === 0), borderColor: "#ff4d6d", tension: 0.1, pointRadius: 0 }
            ]
        },
        options: { responsive: true, maintainAspectRatio: false }
    });
    }

    function renderCorrelation(data) {
    const tickers = data.tickers || [];
    const matrix = data.correlation_matrix || [];
    
    let html = `<table><tr><th></th>`;
    tickers.forEach(t => html += `<th>${t}</th>`);
    html += `</tr>`;
    
    for (let i = 0; i < tickers.length; i++) {
        html += `<tr><th>${tickers[i]}</th>`;
        for (let j = 0; j < tickers.length; j++) {
            const val = matrix[i]?.[j] || 0;
            const color = val > 0.7 ? "#ff4d6d" : val > 0.3 ? "#ffb347" : "#00ffc6";
            html += `<td style="background-color: ${color}20;">${val.toFixed(3)}</td>`;
        }
        html += `</tr>`;
    }
    html += `</table>`;
    document.getElementById("correlationMatrix").innerHTML = html;

    // Covariance matrix
    const cov = data.covariance_matrix || [];
    let covHtml = `<table><tr><th></th>`;
    tickers.forEach(t => covHtml += `<th>${t}</th>`);
    covHtml += `</tr>`;
    
    for (let i = 0; i < tickers.length; i++) {
        covHtml += `<tr><th>${tickers[i]}</th>`;
        for (let j = 0; j < tickers.length; j++) {
            const val = cov[i]?.[j] || 0;
            covHtml += `<td>${val.toFixed(6)}</td>`;
        }
        covHtml += `</tr>`;
    }
    covHtml += `</table>`;
    document.getElementById("covarianceMatrix").innerHTML = covHtml;
    }

    function renderIndividualRisk(assets) {
    let html = `<table><tr><th>Ticker</th><th>Weight</th><th>Return %</th><th>Volatility %</th><th>VaR (95%) %</th><th>Sharpe</th></tr>`;
    
    (assets || []).forEach(a => {
        html += `<tr>
            <td>${a.ticker}</td>
            <td>${(a.weight * 100).toFixed(1)}%</td>
            <td>${a.annualized_return_pct || 0}</td>
            <td>${a.annualized_volatility_pct || 0}</td>
            <td>${a.historical_var_1d_pct || 0}</td>
            <td>${a.sharpe_ratio || 0}</td>
        </tr>`;
    });
    html += `</table>`;
    document.getElementById("individualRiskTable").innerHTML = html;
    }

    async function runMonteCarlo() {
    const h = getHoldingsFromUI();
    if (!h.length) return showMessage("Enter at least one asset");

    const sims = parseInt(document.getElementById("mcSims").value) || 5000;
    const days = parseInt(document.getElementById("mcDays").value) || 252;
    const invest = parseFloat(document.getElementById("mcInvest").value) || 100000;

    try {
        const result = await callApi("/api/simulate/monte-carlo", {
            holdings: h,
            num_simulations: sims,
            num_days: days,
            investment_amount: invest
        });

        const stats = result.terminal_value_stats || {};
        document.getElementById("mcStats").innerHTML = `
            <div class="metric-item"><div class="metric-label">Expected Value</div><div class="metric-value">‚Çπ${stats.mean?.toLocaleString() || 0}</div></div>
            <div class="metric-item"><div class="metric-label">5th Percentile</div><div class="metric-value">‚Çπ${stats.percentile_5?.toLocaleString() || 0}</div></div>
            <div class="metric-item"><div class="metric-label">95th Percentile</div><div class="metric-value">‚Çπ${stats.percentile_95?.toLocaleString() || 0}</div></div>
            <div class="metric-item"><div class="metric-label">Prob Loss</div><div class="metric-value">${(result.probability_of_loss * 100).toFixed(1)}%</div></div>
        `;

        // Chart
        if (mcChartInstance) mcChartInstance.destroy();
        const paths = result.percentile_paths || {};
        const ctx = document.getElementById("mcChart").getContext("2d");
        mcChartInstance = new Chart(ctx, {
            type: "line",
            data: {
                labels: Array.from({length: (paths.p50 || []).length}, (_, i) => i),
                datasets: [
                    { label: "p5", data: paths.p5 || [], borderColor: "#ff4d6d", tension: 0, pointRadius: 0 },
                    { label: "p50", data: paths.p50 || [], borderColor: "#00ffc6", tension: 0, pointRadius: 0, borderWidth: 2 },
                    { label: "p95", data: paths.p95 || [], borderColor: "#4CAF50", tension: 0, pointRadius: 0 }
                ]
            },
            options: { responsive: true, maintainAspectRatio: false }
        });

        showMessage("‚úÖ Simulation complete", false);
    } catch (e) {
        showMessage(e.message);
    }
    }

    async function runShockAnalysis() {
    const h = getHoldingsFromUI();
    const shocks = {};
    document.querySelectorAll(".shock-row").forEach(row => {
        const ticker = row.querySelector("input[type='hidden']").value.toUpperCase();
        const pct = parseFloat(row.querySelector(".shock-pct").value) / 100;
        if (ticker && !isNaN(pct)) shocks[ticker] = pct;
    });

    if (!Object.keys(shocks).length) return showMessage("Enter at least one shock");

    try {
        const result = await callApi("/api/scenario/shock", { holdings: h, shocks });
        
        let html = `<div style="flex:1;"><h3>Before Shock</h3>`;
        const before = result.before || {};
        html += `<div>Return: ${before.annualized_return_pct || 0}%</div>`;
        html += `<div>Volatility: ${before.annualized_volatility_pct || 0}%</div>`;
        html += `<div>Value: ‚Çπ${before.portfolio_value?.toLocaleString() || 0}</div>`;
        html += `</div>`;

        html += `<div style="flex:1;"><h3>After Shock</h3>`;
        const after = result.after || {};
        html += `<div>Return: ${after.annualized_return_pct || 0}%</div>`;
        html += `<div>Volatility: ${after.annualized_volatility_pct || 0}%</div>`;
        html += `<div class="negative">Loss: ‚Çπ${Math.abs(after.portfolio_change_dollar || 0)}  (${after.portfolio_change_pct}%)</div>`;
        html += `</div>`;

        document.getElementById("shockResults").innerHTML = html;
        showMessage("‚úÖ Shock analysis complete", false);
    } catch (e) {
        showMessage(e.message);
    }
    }

    async function runStressTest() {
    const h = getHoldingsFromUI();
    const scenario = document.getElementById("scenarioSelect").value;

    if (!scenario) return showMessage("Select a scenario");

    try {
        const result = await callApi("/api/scenario/stress-test", { holdings: h, scenario });
        
        const impact = result.portfolio_impact || {};
        let html = `
            <div class="metrics-grid">
                <div class="metric-item">
                    <div class="metric-label">Original Value</div>
                    <div class="metric-value">‚Çπ${impact.original_value?.toLocaleString() || 0}</div>
                </div>
                <div class="metric-item">
                    <div class="metric-label">Stressed Value</div>
                    <div class="metric-value negative">‚Çπ${impact.stressed_value?.toLocaleString() || 0}</div>
                </div>
                <div class="metric-item">
                    <div class="metric-label">Total Loss</div>
                    <div class="metric-value negative">‚Çπ${Math.abs(impact.total_loss_dollar || 0)} (${impact.total_loss_pct}%)</div>
                </div>
            </div>
            <h3 style="margin-top: 2rem;">Asset Impacts</h3>
            <table>
                <tr><th>Ticker</th><th>Weight</th><th>Beta</th><th>Shock %</th><th>Dollar Impact</th></tr>
        `;

        (result.asset_impacts || []).forEach(a => {
            html += `<tr><td>${a.ticker}</td><td>${(a.weight * 100).toFixed(1)}%</td><td>${a.beta}</td><td>${a.estimated_shock_pct}%</td><td class="negative">‚Çπ${Math.abs(a.dollar_impact)}</td></tr>`;
        });
        html += `</table>`;

        document.getElementById("stressResults").innerHTML = html;
        showMessage("‚úÖ Stress test complete", false);
    } catch (e) {
        showMessage(e.message);
    }
    }

    /* ================= TAB SWITCH ================= */
    function switchTab(tabId) {
    document.querySelectorAll(".tab-content").forEach(el => el.style.display = "none");
    document.getElementById(tabId).style.display = "block";
    document.querySelectorAll(".tab").forEach(t => t.classList.remove("active"));
    document.querySelector(`.tab[data-tab="${tabId}"]`).classList.add("active");
    }

    /* ================= EXPOSE ================= */
    window.addTickerRow = addTickerRow;
    window.removeRow = removeRow;
    window.validateTickers = validateTickers;
    window.loadFullAnalysis = loadFullAnalysis;
    window.switchTab = switchTab;
    window.runMonteCarlo = runMonteCarlo;
    window.runShockAnalysis = runShockAnalysis;
    window.runStressTest = runStressTest;
    window.initShockInputs = initShockInputs;
    window.initScenariosDropdown = initScenariosDropdown;
    window.updateLiveMarquee = updateLiveMarquee;
    window.checkApiConnection = checkApiConnection;

    </script>
   
</body>

</html>
